define("format_flexsections/local/content",["exports","core_courseformat/local/content","core_courseformat/courseeditor","format_flexsections/local/content/section","core_courseformat/local/content/section/cmitem","format_flexsections/local/courseeditor/mutations","format_flexsections/local/content/actions","format_flexsections/local/courseeditor/exporter","core/str"],(function(_exports,_content,_courseeditor,_section,_cmitem,_mutations,_actions,_exporter,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course format component
   *
   * @module     format_flexsections/local/content
   * @copyright  2022 Marina Glancy
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_content=_interopRequireDefault(_content),_section=_interopRequireDefault(_section),_cmitem=_interopRequireDefault(_cmitem),_mutations=_interopRequireDefault(_mutations),_actions=_interopRequireDefault(_actions),_exporter=_interopRequireDefault(_exporter);class FlexsectionComponent extends _content.default{static init(target,selectors,sectionReturn){var _courseEditor$mutatio,_courseEditor$mutatio2;const courseEditor=(0,_courseeditor.getCurrentCourseEditor)();courseEditor.getExporter=()=>new _exporter.default(courseEditor);let legacyActivityAction=null!==(_courseEditor$mutatio=courseEditor.mutations.legacyActivityAction)&&void 0!==_courseEditor$mutatio?_courseEditor$mutatio:{},legacySectionAction=null!==(_courseEditor$mutatio2=courseEditor.mutations.legacySectionAction)&&void 0!==_courseEditor$mutatio2?_courseEditor$mutatio2:{};return courseEditor.setMutations(new _mutations.default),courseEditor.addMutations({legacyActivityAction:legacyActivityAction,legacySectionAction:legacySectionAction}),new FlexsectionComponent({element:document.getElementById(target),reactive:courseEditor,selectors:selectors,sectionReturn:sectionReturn})}create(descriptor){super.create(descriptor),this.name="course_format_flexsections",this.selectors.COURSE_SUBSECTIONLIST="[data-for='course_subsectionlist']",this.selectors.SECTION_ADD_SUBSECTION="[data-action-flexsections='addSubSection']"}stateReady(state){super.stateReady(state),this.reactive.supportComponents&&this.reactive.isEditing&&new _actions.default(this)}getWatchers(){let res=super.getWatchers();return res.push({watch:"course.hierarchy:updated",handler:this._refreshCourseHierarchy}),res.push({watch:"section.collapsed:updated",handler:this._reloadSection}),res.push({watch:"section.title:updated",handler:this._refreshSectionTitle}),res}_refreshCourseHierarchy(_ref){var _element$hierarchy;let{element:element}=_ref;const hierarchy=null!==(_element$hierarchy=element.hierarchy)&&void 0!==_element$hierarchy?_element$hierarchy:[],createSection=this._createSectionItem.bind(this);for(let i=0;i<hierarchy.length;i++){const sectionlist=hierarchy[i].children,listparent=this.getElement(this.selectors.COURSE_SUBSECTIONLIST+"[data-parent='".concat(hierarchy[i].id,"']"));listparent&&this._fixOrder(listparent,sectionlist,this.selectors.SECTION,this.dettachedSections,createSection)}}_refreshSectionTitle(_ref2){let{element:element}=_ref2;const el=this.getElement(this.selectors.SECTION_ADD_SUBSECTION+"[data-parentid='".concat(element.id,"']"));el&&(0,_str.get_string)("addsubsectionfor","format_flexsections",element.title).then((s=>(el.innerHTML=s,null))).catch((()=>null))}_indexContents(){this._scanIndex(this.selectors.SECTION,this.sections,(item=>new _section.default(item))),this._scanIndex(this.selectors.CM,this.cms,(item=>new _cmitem.default(item)))}_refreshAllSectionsToggler(state){const target=this.getElement(this.selectors.TOGGLEALL);if(!target)return;let allcollapsed=!0,allexpanded=!0;const mainSection=this._mainSection(state),sections=this._getSectionsWithCollapse(state);for(let i in sections)parseInt(sections[i].parent)===mainSection&&(allcollapsed=allcollapsed&&sections[i].contentcollapsed),allexpanded=allexpanded&&!sections[i].contentcollapsed;allcollapsed&&(target.classList.add(this.classes.COLLAPSED),target.setAttribute("aria-expanded",!1)),allexpanded&&(target.classList.remove(this.classes.COLLAPSED),target.setAttribute("aria-expanded",!0))}_allSectionToggler(event){event.preventDefault();const isAllCollapsed=event.target.closest(this.selectors.TOGGLEALL).classList.contains(this.classes.COLLAPSED),sections=this._getSectionsWithCollapse();let ids=[];for(let i in sections)ids.push(sections[i].id);this.reactive.dispatch("sectionContentCollapsed",ids,!isAllCollapsed)}_mainSection(state){const sectionsList=state.course.sectionlist;let sectionNumber=0;return 1===sectionsList.length&&state.section.forEach((s=>{"".concat(s.id)==="".concat(sectionsList[0])&&(sectionNumber=parseInt(s.number))})),sectionNumber}_getSectionsWithCollapse(state){void 0===state&&(state=this.reactive.stateManager.state);const mainSection=this._mainSection(state);let parents={};parents["".concat(mainSection)]="".concat(mainSection);let displayedSections=[];return state.section.forEach((section=>{const sectionNumber=parseInt(section.number);sectionNumber&&sectionNumber!==mainSection&&"".concat(section.parent)in parents&&!section.collapsed&&(parents["".concat(sectionNumber)]="".concat(sectionNumber),displayedSections.push(section))})),displayedSections}}return _exports.default=FlexsectionComponent,_exports.default}));

//# sourceMappingURL=content.min.js.map